module.exports=function(e){var t={};function s(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=e,s.c=t,s.d=function(e,t,a){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(s.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(a,n,function(t){return e[t]}.bind(null,n));return a},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=22)}([function(e,t){e.exports=flarum.core.compat.app},function(e,t){e.exports=flarum.core.compat.Model},function(e,t){e.exports=flarum.core.compat["components/Button"]},function(e,t){e.exports=flarum.core.compat["utils/Stream"]},function(e,t){e.exports=flarum.core.compat.extend},function(e,t){e.exports=flarum.core.compat["components/Modal"]},function(e,t){e.exports=flarum.core.compat["helpers/username"]},function(e,t){e.exports=flarum.core.compat["helpers/humanTime"]},function(e,t){e.exports=flarum.core.compat["components/UserPage"]},function(e,t){e.exports=flarum.core.compat["models/User"]},function(e,t){e.exports=flarum.core.compat["utils/withAttr"]},function(e,t){e.exports=flarum.core.compat["utils/computed"]},function(e,t){e.exports=flarum.core.compat["utils/mixin"]},function(e,t){e.exports=flarum.core.compat["components/SettingsPage"]},function(e,t){e.exports=flarum.core.compat["components/Page"]},function(e,t){e.exports=flarum.core.compat.Component},function(e,t){e.exports=flarum.core.compat["components/LoadingIndicator"]},function(e,t){e.exports=flarum.core.compat["helpers/avatar"]},function(e,t){e.exports=flarum.core.compat["helpers/icon"]},function(e,t){e.exports=flarum.core.compat["components/HeaderSecondary"]},function(e,t){e.exports=flarum.core.compat["components/NotificationsDropdown"]},function(e,t){e.exports=flarum.core.compat["components/LinkButton"]},function(e,t,s){"use strict";s.r(t);var a=s(9),n=s.n(a),r=s(1),o=s.n(r);function i(e,t){return(i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,i(e,t)}var c=s(11),p=s.n(c),l=s(12),f=function(e){function t(){return e.apply(this,arguments)||this}return u(t,e),t}(s.n(l)()(o.a,{user:o.a.hasOne("user"),status:o.a.attribute("status"),reason:o.a.attribute("reason"),createdAt:o.a.attribute("createdAt",o.a.transformDate),forNickname:o.a.attribute("forNickname"),_requestedUsername:o.a.attribute("requestedUsername"),requestedUsername:p()("_requestedUsername","forNickname","user",(function(e,t,s){return null===e&&t?s.username():e}))})),d=s(4),h=s(2),q=s.n(h),N=s(13),v=s.n(N),y=s(3),b=s.n(y),x=s(5),_=s.n(x),g=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.username=b()(this.attrs.nickname?app.session.user.displayName():app.session.user.username()),this.userRequestAttr="last"+(this.attrs.nickname?"Nickname":"Username")+"Request",this.lastRequest=app.session.user[this.userRequestAttr](),this.lastRequest&&this.username(this.lastRequest.requestedUsername()),this.success=!1,this.password=b()(""),this.translationPrefix="fof-username-request.forum."+(this.attrs.nickname?"nickname":"username")+"_modals.request"},s.className=function(){return"RequestUsernameModal Modal--small"},s.title=function(){return app.translator.trans(this.translationPrefix+".title")},s.content=function(){return this.success?m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},m("p",{className:"helpText"},app.translator.trans(this.translationPrefix+".confirmation_message")),m("div",{className:"Form-group"},m(q.a,{className:"Button Button--primary Button--block",onclick:this.hide.bind(this)},app.translator.trans(this.translationPrefix+".dismiss_button"))))):m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},this.lastRequest?m("p",{className:"helpText"},app.translator.trans(this.translationPrefix+".current_request",{name:this.lastRequest.requestedUsername()})):"",m("div",{className:"Form-group"},m("input",{type:"text",name:"text",className:"FormControl",placeholder:app.session.user.username(),bidi:this.username,disabled:this.deleteLoading||this.submitLoading})),m("div",{className:"Form-group"},m("input",{type:"password",name:"password",className:"FormControl",placeholder:app.translator.trans("core.forum.change_email.confirm_password_placeholder"),bidi:this.password,disabled:this.deleteLoading||this.submitLoading})),m("div",{className:"Form-group"},q.a.component({className:"Button Button--primary Button--block",type:"submit",loading:this.submitLoading},app.translator.trans(this.translationPrefix+".submit_button"))),this.lastRequest?m("div",{className:"Form-group"},q.a.component({className:"Button Button--primary Button--block",onclick:this.deleteRequest.bind(this),loading:this.deleteLoading},app.translator.trans(this.translationPrefix+".delete_button"))):""))},s.deleteRequest=function(e){e.preventDefault(),this.deleteLoading=!0,this.lastRequest.delete(),this.successAlert=app.alerts.show({type:"success"},app.translator.trans(this.translationPrefix+".deleted")),app.session.user[this.userRequestAttr]=b()(),this.hide()},s.onsubmit=function(e){var t=this;e.preventDefault(),this.alert=null;var s=this.attrs.nickname?app.session.user.displayName():app.session.user.username();this.username()!==s?(this.submitLoading=!0,app.store.createRecord("username-requests").save({username:this.username(),forNickname:this.attrs.nickname},{meta:{password:this.password()},errorHandler:this.onerror.bind(this)}).then((function(e){app.session.user[t.userRequestAttr]=b()(e),t.success=!0,t.alertAttrs=null})).catch((function(){})).then(this.loaded.bind(this))):this.hide()},s.onerror=function(t){401===t.status&&(t.alert.content=app.translator.trans("core.forum.change_email.incorrect_password_message")),e.prototype.onerror.call(this,t)},t}(_.a),k=s(14),R=s.n(k),P=s(15),w=s.n(P),A=s(16),U=s.n(A),j=s(17),B=s.n(j),F=s(6),M=s.n(F),O=s(18),L=s.n(O),C=s(7),S=s.n(C),T=s(10),D=s.n(T),H=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.request=this.attrs.request,this.approved=b()("Rejected"),this.reason=b()(""),this.translationPrefix="fof-username-request.forum."+(this.request.forNickname()?"nickname":"username")+"_modals.action"},s.title=function(){return app.translator.trans(this.translationPrefix+".title")},s.className=function(){return"RequestActionModal Modal--medium"},s.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form"},m("h3",{className:"Notification-content"},app.translator.trans(this.translationPrefix+".name",{name:M()(this.request.user()),requestedName:this.request.requestedUsername()})),m("p",{className:"help"},app.translator.trans(this.translationPrefix+".help_text")),m("legend",null,app.translator.trans(this.translationPrefix+".decision_title")),m("div",{className:"Form-group"},m("label",{className:"checkbox"},m("input",{type:"radio",name:"approved",value:"Approved",checked:"Approved"===this.approved(),onclick:D()("value",this.approved)}),app.translator.trans(this.translationPrefix+".approval_label")),m("label",{className:"checkbox"},m("input",{type:"radio",name:"rejected",value:"Rejected",checked:"Rejected"===this.approved(),onclick:D()("value",this.approved)}),app.translator.trans(this.translationPrefix+".rejected_label"))),"Rejected"===this.approved()?m("div",{className:"Form-group"},m("legend",null,app.translator.trans(this.translationPrefix+".reason_title")),m("div",{className:"BasicsPage-reason-input"},m("textarea",{className:"FormControl",value:this.reason(),disabled:this.loading,oninput:D()("value",this.reason)}))):"",m("div",{className:"Form-group"},q.a.component({className:"Button Button--primary Button--block",type:"submit",loading:this.loading,disabled:"Rejected"===this.approved()&&!this.reason()},app.translator.trans(this.translationPrefix+".submit_button")))))},s.onsubmit=function(e){var t=this;e.preventDefault(),this.loading=!0,this.request.save({reason:this.reason(),action:this.approved()}).then((function(){t.successAlert=app.alerts.show({type:"success"},app.translator.trans(t.translationPrefix+".success"))})),app.cache.username_requests.some((function(e,s){e.id()==t.request.id()&&app.cache.username_requests.splice(s,1)})),m.redraw(),this.hide()},t}(_.a),I=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.loading=!1},s.view=function(){var e=this,t=app.cache.username_requests||[];return m("div",{className:"NotificationList RequestsList"},m("div",{className:"NotificationList-header"},m("h4",{className:"App-titleControl App-titleControl--text"},app.translator.trans("fof-username-request.forum.pending_requests.title"))),m("div",{className:"NotificationList-content"},m("ul",{className:"NotificationGroup-content"},t.length?t.map((function(t){var s=t.forNickname()?"nickname":"username";return m("li",null,m("a",{onclick:e.showModal.bind(e,t),className:"Notification Request"},B()(t.user()),L()("fas fa-user-edit",{className:"Notification-icon"}),m("span",{className:"Notification-content"},app.translator.trans("fof-username-request.forum.pending_requests."+s+"_item_text",{name:M()(t.user())})),S()(t.createdAt()),m("div",{className:"Notification-excerpt"},app.translator.trans("fof-username-request.forum.pending_requests."+s+"_exerpt",{requestedName:t.requestedUsername()}))))})):this.loading?U.a.component({className:"LoadingIndicator--block"}):m("div",{className:"NotificationList-empty"},app.translator.trans("fof-username-request.forum.pending_requests.empty_text")))))},s.showModal=function(e){app.modal.show(H,{request:e})},t}(w.a),G=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),app.history.push("requests"),this.bodyClass="App--requests"},s.view=function(){return m("div",{className:"RequestsPage"},m(I,{state:app.usernameRequests}))},t}(R.a),z=s(0),E=s.n(z),J=s(19),K=s.n(J),Q=s(20),V=function(e){function t(){return e.apply(this,arguments)||this}u(t,e),t.initAttrs=function(t){t.label=t.label||app.translator.trans("fof-username-request.forum.pending_requests.tooltip"),t.icon=t.icon||"fas fa-user-edit",e.initAttrs.call(this,t)};var s=t.prototype;return s.getMenu=function(){return m("div",{className:"Dropdown-menu "+this.attrs.menuClassName,onclick:this.menuClick.bind(this)},this.showing?I.component({state:app.usernameRequests}):"")},s.goToRoute=function(){m.route.set(app.route("username_requests"))},s.getUnreadCount=function(){return app.cache.username_requests?app.cache.username_requests.length:app.forum.data.relationships.username_requests.data.length},s.getNewCount=function(){return app.cache.username_requests?app.cache.username_requests.length:app.forum.data.relationships.username_requests.data.length},t}(s.n(Q).a),W=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.userRequestAttr="last"+(this.attrs.nickname?"Nickname":"Username")+"Request",this.request=app.session.user[this.userRequestAttr](),this.translationPrefix="fof-username-request.forum."+(this.request.forNickname()?"nickname":"username")+"_modals.results"},s.className=function(){return"ResultsModal Modal"},s.title=function(){return app.translator.trans(this.translationPrefix+".title")},s.content=function(){return m("div",{className:"Modal-body"},m("div",{className:"Form Form--centered"},"Approved"===this.request.status()?[m("h2",null,app.translator.trans(this.translationPrefix+".approved")),m("h3",null,app.translator.trans(this.translationPrefix+".new_name",{name:app.session.user.displayName()}))]:[m("h2",null,app.translator.trans(this.translationPrefix+".rejected")),m("h3",null,app.translator.trans(this.translationPrefix+".reason",{reason:this.request.reason(),i:m("i",null)})),m("p",{className:"helpText"},app.translator.trans(this.translationPrefix+".resubmit"))],m("div",{className:"Form-group"},m(q.a,{className:"Button Button--primary Button--block",onclick:this.hide.bind(this)},app.translator.trans(this.translationPrefix+".dismiss_button")))))},s.onremove=function(){app.session.user[this.userRequestAttr]=b()(),this.request.save({delete:!0})},t}(_.a),X=s(8),Y=s.n(X),Z=function(e){function t(){return e.apply(this,arguments)||this}u(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.loading=!0,this.loadUser(m.route.param("username"))},s.content=function(){var e=this;return m("table",{className:"NotificationGrid"},this.user.usernameHistory().slice(0).reverse().map((function(t){var s=Object.keys(t)[0];return m("tr",null,m("td",null,s),m("td",null,S()(e.calculateTime(t[s]))))})))},s.show=function(e){this.user=e,m.redraw()},s.calculateTime=function(e){return new Date(0).setUTCSeconds(e)},t}(Y.a),$=s(21),ee=s.n($),te=function(){function e(e){this.app=e,this.loading=!1,this.cache=[]}return e.prototype.load=function(){var e=this;app.cache.username_requests||(this.loading=!0,m.redraw(),app.store.find("username-requests").then((function(e){delete e.payload,app.cache.username_requests=e.sort((function(e,t){return e.createdAt()-t.createdAt()}))})).catch((function(){})).then((function(){e.loading=!1,m.redraw()})))},e}();app.initializers.add("fof-username-request",(function(){app.store.models["username-requests"]=f,n.a.prototype.lastNicknameRequest=o.a.hasOne("lastNicknameRequest"),n.a.prototype.lastUsernameRequest=o.a.hasOne("lastUsernameRequest"),n.a.prototype.usernameHistory=o.a.attribute("usernameHistory"),app.routes.username_requests={path:"/username-requests",component:G},app.routes.username_history={path:"/u/:username/history",component:Z},app.usernameRequests=new te(app),Object(d.extend)(v.a.prototype,"accountItems",(function(e){app.forum.attribute("canRequestUsername")&&e.add("username-request",q.a.component({className:"Button",onclick:function(){app.modal.show(g)}},app.translator.trans("fof-username-request.forum.settings.username_request_button")),8),"nickname"===app.forum.attribute("displayNameDriver")&&app.forum.attribute("canRequestNickname")&&!this.user.attribute("canEditOwnNickname")&&"flarum-nicknames"in flarum.extensions&&e.add("nickname-request",q.a.component({className:"Button",onclick:function(){app.modal.show(g,{nickname:!0})}},app.translator.trans("fof-username-request.forum.settings.nickname_request_button")),8)})),Object(d.extend)(K.a.prototype,"items",(function(e){(E.a.forum.data.relationships.username_requests&&E.a.forum.data.relationships.username_requests.data.length&&!E.a.cache.username_requests||E.a.cache.username_requests&&0!==E.a.cache.username_requests.length)&&e.add("UsernameRequests",m(V,{state:E.a.usernameRequests}),20)})),new Promise((function(){setTimeout((function(){if(E.a.session.user){var e=E.a.session.user.lastNicknameRequest()&&"Sent"!==E.a.session.user.lastNicknameRequest().status(),t=E.a.session.user.lastUsernameRequest()&&"Sent"!==E.a.session.user.lastUsernameRequest().status();(e||t)&&E.a.modal.show(W,{nickname:e})}}),1e3)})),Object(d.extend)(Y.a.prototype,"navItems",(function(e){this.user.usernameHistory()&&e.add("username-requests",ee.a.component({href:E.a.route("username_history",{username:this.user.username()}),icon:"fas fa-user-edit"},E.a.translator.trans("fof-username-request.forum.user.name_history_link")))}))}))}]);
//# sourceMappingURL=forum.js.map